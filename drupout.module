<?php

/**
 * @file
 * Module that allows creating and editing Speakout campaigns from a webform
 */

/**
 * Simple slugifiyer
 * Replaces all non-slug characters with _
 */
function drupout_slugify($str, $sep='-') {
  return strtolower(preg_replace('/[^a-zA-Z0-9-_]+/', $sep, $str));
}

function drupout_form2json($node, $submission) {
  $keys = array();
  foreach ($node->webform['components'] as $cid => $component) {
    $keys[$component['form_key']] = $cid;
  }

  $title = $submission->data[$keys['civicrm_1_activity_1_activity_subject']][0];
  $date_prefix = date('Ym');
  $language = 'EN';
  $img_file = file_load($submission->data[$keys['add_an_image']][0]);
  $jsonData = array(
    'name' => $title,
    'slug' => drupout_slugify($title),
    'internal_name' => $date_prefix . '-' . drupout_slugify($title, '_') . '-' . $language,
    'image_url' => file_create_url($img_file->uri),
    'description' => $submission->data[$keys['add_texts_for_social_media_shares']][0],
    'twitter_share_text' => $submission->data[$keys['add_texts_for_ttwitter']][0],
    'decisions_attr' => array(
      'display_name' => $submission->data[$keys['who_are_you_addressing_who_in_the_european_union_can_make_this_happen']][0]
    ),
    'variables' => array(
      'sign_advice' => array(
        'petition' => $submission->data[$keys['what_do_you_want_them_to_do']][0],
	'why_important' => $submission->data[$keys['why_is_this_important']][0]
      )
    )
  );

  return $jsonData;
}

function drupout_webform_submission_insert($node, $submission) {
  if ($node->nid == variable_get('drupout_submission_node')) {
    watchdog('drupout', print_r($submission, true));
    $root_endpoint = variable_get('drupout_endpoint', 'http://localhost:3000/api');
    $user = variable_get('drupout_speakout_user');
    $password = variable_get('drupout_speakout_password');
    $template_id = variable_get('drupout_speakout_templates');

    $jsonData = drupout_form2json($node, $submission);
     
    $url = "$root_endpoint/campaigns/$template_id/clone";
    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_USERPWD, "$user:$password");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/json')); 
    $jsonDataEncoded = json_encode($jsonData);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $jsonDataEncoded);
     
    $result = curl_exec($ch);
    if ($result) {
      $call_info = curl_getinfo($ch);
      if ($call_info['http_code'] != 201) {
      	watchdog('drupout', print_r($call_info, true));
      }
    } else {
      watchdog('drupout', "Unable to send campaign request to Speakout: " . curl_error($ch));
      //TODO
      //Send email to vesna? tech?
    }

    curl_close($ch);
  }
}

/**
 * Creates the item in the admin main page
 */
function drupout_menu() {
  $items = array();

  $items['admin/config/content/drupout'] = array(
    'title' => "Drupout settings",
    'description' => "Settings to create Speakout campaigns from Drupal",
    'page callback' => 'drupal_get_form',
    'page arguments' => array('drupout_settings_form'),
    'access arguments' => array('access administration pages'),
    'type' => MENU_NORMAL_ITEM
  );

  return $items;
}

/**
 * Generates the config form
 */
function drupout_settings_form($form, &$form_state) {
  $form['drupout_submission_node'] = array(
    '#type' => 'textfield',
    '#title' => t('Submission node'),
    '#default_value' => variable_get('drupout_submission_node'),
    '#description' => t('Drupal node id with the webform to create/edit campaigns'),
    '#required' => true
  );
  $form['drupout_endpoint'] = array(
    '#type' => 'textfield',
    '#title' => t('Speakout API URL'),
    '#default_value' => variable_get('drupout_endpoint', 'http://localhost:3000/api'),
    '#description' => t('URL to the root API controller of Speakout, without trailing slash'),
    '#required' => true
  );
  $form['drupout_speakout_user'] = array(
    '#type' => 'textfield',
    '#title' => t('Speakout user'),
    '#default_value' => variable_get('drupout_speakout_user'),
    '#description' => t('Speakout user'),
    '#required' => true
  );
  $form['drupout_speakout_password'] = array(
    '#type' => 'password',
    '#title' => t('Speakout password'),
    '#default_value' => variable_get('drupout_speakout_password'),
    '#description' => t('Speakout password')
  );
  $form['drupout_speakout_templates'] = array(
    '#type' => 'textfield',
    '#title' => t('Speakout templates'),
    '#default_value' => variable_get('drupout_speakout_templates'),
    '#description' => t('Speakout templates'),
    '#required' => true
  );
  
  return system_settings_form($form);
}

